#!/usr/bin/env ruby

require File.dirname(__FILE__) + '/../lib/word_search'

$DEBUG = true

FileUtils.rm_rf "INDEX-test"

s = Time.now

field_infos = WordSearch::FieldInfos.new
field_infos.add_field(:uri, FileNameAnalyzer.new)

if ARGV.include?("--total")
  analyzer = WordSearch::Analysis::TotalAnalyzer.new
else
  analyzer = WordSearch::Analysis::SimpleIdentifierAnalyzer.new
end

field_infos.add_field(:body, analyzer)

fragment  = WordSearch::FragmentWriter.new("INDEX-test")
fragment.field_infos = field_infos

dir = ARGV[0]
files = `find #{dir} -name "*.rb"`
filenames = files.split("\n")
filenames.each do |filename|
  body = File.read(filename)
  puts "adding #{filename} -- #{body.size}"
  fragment.add_document(:uri => filename, :body => body)
end

puts "writing"
fragment.finish!
puts "took #{Time.now - s}s"


